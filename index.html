<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Investor CSV Upload</title>
</head>
<body>
  <h1>Upload Investor CSV</h1>

  <form id="upload-form">
    <label for="csv-file">Choose CSV file:</label>
    <input type="file" id="csv-file" accept=".csv" required />
    <br><br>

    <label for="rating">Investor Quality (1–5 stars):</label>
    <select id="rating" required>
      <option value="">--Select Rating--</option>
      <option value="5">⭐⭐⭐⭐⭐</option>
      <option value="4">⭐⭐⭐⭐</option>
      <option value="3">⭐⭐⭐</option>
      <option value="2">⭐⭐</option>
      <option value="1">⭐</option>
    </select>
    <br><br>

    <button type="submit">Upload to Supabase</button>
  </form>

  <p id="status"></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const form = document.getElementById("upload-form");
    const status = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById("csv-file");
      const rating = parseInt(document.getElementById("rating").value);

      if (!fileInput.files.length || isNaN(rating)) {
        status.textContent = "Please select a file and rating.";
        return;
      }

      const quality = rating >= 4 ? "high" : rating === 3 ? "medium" : "low";
      const file = fileInput.files[0];

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function (results) {
          const data = results.data.map((row) => ({
            ...row,
            rating: rating,
            quality: quality,
          }));

          try {
            const res = await fetch("https://jaxxualfgczfbcizxzfo.supabase.co/rest/v1/investors", {
              method: "POST",
              headers: {
                "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpheHh1YWxmZ2N6ZmJjaXp4emZvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODM2MzIwMywiZXhwIjoyMDYzOTM5MjAzfQ.PbpgZdwoC1fNe8lRtkHKKqrf_aI3KcEqIiK2uNezP9k",
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpheHh1YWxmZ2N6ZmJjaXp4emZvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODM2MzIwMywiZXhwIjoyMDYzOTM5MjAzfQ.PbpgZdwoC1fNe8lRtkHKKqrf_aI3KcEqIiK2uNezP9k",
                "Content-Type": "application/json",
                "Prefer": "return=representation"
              },
              body: JSON.stringify(data)
            });

            if (res.ok) {
              status.textContent = "Upload successful!";
            } else {
              const error = await res.text();
              status.textContent = "Error uploading: " + error;
            }
          } catch (error) {
            status.textContent = "Upload failed: " + error.message;
          }
        }
      });
    });
  </script>
</body>
</html>
